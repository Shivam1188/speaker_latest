(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[73],{1760:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>h});var n=r(5155),o=r(2115),a=r(1985),s=r(5432),c=r(5695),l=r(9911),i=r(6408),d=r(3568);let u=()=>{let e=(0,a.jL)(),t=(0,c.useRouter)(),r=(0,c.useSearchParams)(),[u,h]=(0,o.useState)(!1),[m,g]=(0,o.useState)(!1),[x,p]=(0,o.useState)(null),f=(0,o.useRef)(null),b=r.get("paragraph")?decodeURIComponent(r.get("paragraph")):null,[w,y]=(0,o.useState)(null),[j,v]=(0,o.useState)(!1),N=(0,o.useRef)(null),k=(0,o.useRef)(null),S=(0,o.useRef)(null),R=(0,o.useRef)([]),[P,A]=(0,o.useState)(!0),C=()=>localStorage.getItem("username")||"unknown_user",E=(0,o.useRef)(null),W=(0,o.useRef)(null),{isRecording:T,isAnalyzing:O,analysisResults:U,error:L}=(0,a.GV)(e=>e.practice),I=()=>{try{let e=localStorage.getItem("access_token")||sessionStorage.getItem("access_token")||"";return e?"Bearer ".concat(e):""}catch(e){return console.error("Error retrieving auth token:",e),""}},M=async()=>{let e=I(),t=C();if(!t||!e)return void d.Ay.error("Authentication required");g(!0);try{let r=await fetch("".concat("https://www.edusmartai.com","/get-tts-audio?username=").concat(t),{headers:{Authorization:"".concat(e)}});if(!r.ok)throw Error("Audio fetch failed");let n=await r.blob(),o=URL.createObjectURL(n);return x&&URL.revokeObjectURL(x),p(o),o}catch(e){return d.Ay.error("Failed to load audio: "+e.message),null}finally{g(!1)}},F=async()=>{if(f.current)if(u)f.current.pause(),h(!1);else try{let e=x;e||(e=await M()),e&&f.current&&(f.current.src!==e&&(f.current.src=e),await f.current.play(),h(!0))}catch(e){console.error("Audio playback failed:",e),d.Ay.error("Failed to play audio")}},_="https://www.edusmartai.com",D=(0,o.useCallback)(async()=>{let e=I();console.log("Testing WebSocket connection with token:",e);let t=_.replace(/^https?:\/\//,""),r=(window.location.protocol,"wss:"),n=new WebSocket("".concat(r,"//").concat(t,"/ws/audio?username=test&token=").concat(encodeURIComponent(e)));n.onopen=()=>{console.log("[TEST] WebSocket connected"),n.send(JSON.stringify({type:"test",data:"Connection test"})),n.close()},n.onerror=e=>{console.error("[TEST] WebSocket error:",e)},n.onmessage=e=>{console.log("[TEST] Received:",e.data)}},[_]),z=async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});N.current&&(N.current.srcObject=e,N.current.play().catch(e=>console.error("Monitoring play error:",e)),v(!0))}catch(e){console.error("Monitoring error:",e),d.Ay.error("Microphone access failed during monitoring")}},B=async()=>{try{let e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind);if(0===e.length)return d.Ay.error("No microphones detected"),!1;return console.log("Available microphones:",e),!0}catch(e){return console.error("Device enumeration error:",e),d.Ay.error("Couldn't access device list"),!1}};(0,o.useEffect)(()=>{b?(e((0,s.az)(b)),D()):(d.Ay.error("No paragraph found for practice"),t.push("/dashboard"))},[e,b,t,D]),(0,o.useEffect)(()=>{L&&d.Ay.error(L)},[L]);let H=async()=>{if(A(!1),y(null),R.current=[],await B())try{let t=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,noiseSuppression:!0,echoCancellation:!0}}),r=t.getAudioTracks();console.log("Active audio tracks:",r),r.forEach(e=>{console.log("Track settings:",e.getSettings()),console.log("Track enabled:",e.enabled),console.log("Track readyState:",e.readyState)}),E.current=t;let n=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3});k.current=n;let o=n.createMediaStreamSource(t),a=n.createScriptProcessor(4096,1,1);S.current=a,a.onaudioprocess=e=>{let t=e.inputBuffer.getChannelData(0),r=new Int16Array(t.length);for(let e=0;e<t.length;e++){let n=Math.max(-1,Math.min(1,t[e]));r[e]=n<0?32768*n:32767*n}R.current.push(r)},o.connect(a),a.connect(n.destination);let c=I();if(!c)return void d.Ay.error("Missing authentication token");let l=C();console.log("Using username:",l);let i=_.replace(/^https?:\/\//,""),u=(window.location.protocol,"wss:"),h=new URLSearchParams({username:encodeURIComponent(l),token:encodeURIComponent(c)}),m=new WebSocket("".concat(u,"//").concat(i,"/ws/audio?").concat(h.toString()));console.log("Connecting to:",m.url),W.current=m,m.onopen=()=>{console.log("WebSocket connected"),console.log("Protocol:",m.protocol),console.log("Extensions:",m.extensions),e((0,s.K3)()),setInterval(()=>{if(0===R.current.length||m.readyState!==WebSocket.OPEN)return;let e=R.current;R.current=[];let t=e.reduce((e,t)=>e+t.length,0),r=new Int16Array(t),n=0;e.forEach(e=>{r.set(e,n),n+=e.length}),m.send(r.buffer)},3e3)},m.onmessage=t=>{let r=JSON.parse(t.data);console.log("Analysis received:",r),e((0,s.LN)(r))},m.onerror=t=>{console.error("WebSocket error:",t),d.Ay.error("WebSocket connection error"),e((0,s.Ww)())},m.onclose=e=>{console.error("WebSocket closed unexpectedly",{code:e.code,reason:e.reason,wasClean:e.wasClean}),d.Ay.error("WebSocket connection closed unexpectedly")};let g=new FileReader;g.onload=()=>{m.readyState===WebSocket.OPEN&&(console.log("Sending audio chunk as ArrayBuffer"),m.send(g.result))},o.connect(a),a.connect(n.destination)}catch(t){console.error("Recording error:",t),d.Ay.error("Failed to access microphone. Please check permissions."),e((0,s.Ww)())}};return(0,o.useEffect)(()=>{let e=f.current;return()=>{e&&e.pause(),W.current&&W.current.close(),E.current&&E.current.getTracks().forEach(e=>e.stop())}},[e]),(0,o.useEffect)(()=>()=>{w&&URL.revokeObjectURL(w)},[w]),(0,o.useEffect)(()=>()=>{x&&URL.revokeObjectURL(x)},[x]),(0,n.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4 py-8",children:(0,n.jsxs)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"w-full max-w-3xl bg-white shadow-xl rounded-xl overflow-hidden",children:[(0,n.jsxs)("div",{className:"bg-indigo-600 py-4 px-6 flex items-center",children:[(0,n.jsx)("button",{onClick:()=>{f.current&&u&&f.current.pause(),e((0,s.Ct)()),t.push("/dashboard")},className:"text-white mr-4 p-2 rounded-full hover:bg-indigo-700 transition-colors",children:(0,n.jsx)(l.QVr,{})}),(0,n.jsx)("h2",{className:"text-2xl font-bold text-white text-center flex-grow",children:"Practice Your English"})]}),(0,n.jsx)("div",{className:"p-6",children:O&&!b?(0,n.jsxs)("div",{className:"flex justify-center items-center h-64",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"}),(0,n.jsx)("span",{className:"ml-4 text-gray-700",children:"Loading practice session..."})]}):(0,n.jsxs)(n.Fragment,{children:[!T&&(0,n.jsxs)("div",{className:"mb-8 bg-indigo-50 p-4 rounded-xl border border-indigo-100 transition-all duration-500",children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-indigo-800 mb-3",children:"Read this paragraph aloud:"}),(0,n.jsx)("div",{className:"bg-white p-4 rounded-lg shadow-inner max-h-60 overflow-y-auto",children:(0,n.jsx)("p",{className:"text-gray-700 leading-relaxed whitespace-pre-line",children:b})})]}),(0,n.jsxs)("div",{className:"mb-8 flex justify-center",children:[(0,n.jsxs)("button",{onClick:F,disabled:m||T,className:"flex items-center justify-center ".concat(m?"bg-gray-300 cursor-not-allowed":"bg-indigo-100 hover:bg-indigo-200"," text-indigo-600 p-4 rounded-full transition-colors min-w-[180px]"),children:[m?(0,n.jsx)(l.hW,{className:"animate-spin text-xl"}):u?(0,n.jsx)(l.kwt,{className:"text-xl"}):(0,n.jsx)(l.gSK,{className:"text-xl"}),(0,n.jsx)("span",{className:"ml-2",children:m?"Loading...":u?"Pause":"Listen Again"})]}),(0,n.jsx)("audio",{ref:f,src:x,onPlay:()=>h(!0),onPause:()=>h(!1),onEnded:()=>h(!1),onLoadedData:()=>g(!1),onWaiting:()=>g(!0),onCanPlay:()=>g(!1),className:"hidden"})]}),(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center my-8",children:[P&&!T&&(0,n.jsx)(i.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded",children:(0,n.jsxs)("div",{className:"flex",children:[(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsx)("svg",{className:"h-5 w-5 text-yellow-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),(0,n.jsx)("div",{className:"ml-3",children:(0,n.jsx)("p",{className:"text-sm text-yellow-700",children:"The paragraph will be hidden when you start recording to encourage memorization and natural speech."})})]})}),T?(0,n.jsx)(i.P.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>{if(A(!1),S.current&&(S.current.disconnect(),S.current=null),k.current&&(k.current.close(),k.current=null),E.current&&E.current.getTracks().forEach(e=>e.stop()),W.current){let e=W.current;if(R.current.length>0&&e.readyState===WebSocket.OPEN){let t=R.current;R.current=[];let r=new Int16Array(t.reduce((e,t)=>e+t.length,0)),n=0;t.forEach(e=>{r.set(e,n),n+=e.length}),e.send(r.buffer)}e.sendInterval&&clearInterval(e.sendInterval),e.readyState===WebSocket.OPEN?(e.send(JSON.stringify({action:"end"})),e.close(1e3,"Recording completed")):e.close()}e((0,s.Ww)())},className:"bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-full p-6 shadow-lg hover:shadow-xl transition-all duration-300",children:(0,n.jsx)(l.wFo,{className:"text-3xl"})}):(0,n.jsx)(i.P.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:H,className:"bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-full p-6 shadow-lg hover:shadow-xl transition-all duration-300",disabled:O,children:(0,n.jsx)(l.i0t,{className:"text-3xl"})}),(0,n.jsx)("p",{className:"mt-4 text-gray-600",children:T?"Recording... Click to stop.":"Click the microphone to start recording."}),T&&(0,n.jsx)("div",{className:"mt-4 flex space-x-2",children:[void 0,void 0,void 0,void 0,void 0].map((e,t)=>(0,n.jsx)(i.P.div,{animate:{height:[10,30,10]},transition:{duration:1,repeat:1/0,delay:.2*t},className:"w-3 bg-indigo-500 rounded-full"},t))})]}),U&&(0,n.jsxs)(i.P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"mt-8 p-6 bg-white rounded-xl border border-indigo-100 shadow-md",children:[(0,n.jsx)("h3",{className:"text-xl font-semibold text-indigo-800 mb-4",children:"Your Analysis Results"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"bg-indigo-50 p-4 rounded-lg",children:[(0,n.jsx)("h4",{className:"font-medium text-indigo-700",children:"Pronunciation"}),(0,n.jsxs)("p",{className:"text-2xl font-bold text-indigo-600",children:[U.pronunciationScore||"8.5","/10"]})]}),(0,n.jsxs)("div",{className:"bg-indigo-50 p-4 rounded-lg",children:[(0,n.jsx)("h4",{className:"font-medium text-indigo-700",children:"Fluency"}),(0,n.jsxs)("p",{className:"text-2xl font-bold text-indigo-600",children:[U.fluencyScore||"7.2","/10"]})]})]}),(0,n.jsx)("h3",{className:"font-bold text-blue-800 mb-2",children:"Microphone Diagnostics"}),(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsxs)("button",{onClick:j?()=>{N.current&&N.current.srcObject&&(N.current.srcObject.getTracks().forEach(e=>e.stop()),N.current.srcObject=null,v(!1))}:z,className:"flex items-center px-4 py-2 rounded-md ".concat(j?"bg-red-500 hover:bg-red-600":"bg-blue-500 hover:bg-blue-600"," text-white"),children:[j?(0,n.jsx)(l.FZ2,{className:"mr-2"}):(0,n.jsx)(l.pPd,{className:"mr-2"}),j?"Stop Monitoring":"Test Microphone"]}),(0,n.jsx)("p",{className:"text-sm text-blue-700",children:j?"You should hear your microphone input now":"Click to verify microphone works"})]}),(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("h4",{className:"font-medium text-indigo-700 mb-2",children:"Feedback"}),(0,n.jsx)("ul",{className:"space-y-2",children:(U.feedback||["Good job on pronunciation!","Try to speak a bit slower for better clarity.","Watch your intonation on questions."]).map((e,t)=>(0,n.jsxs)("li",{className:"flex items-start",children:[(0,n.jsx)("span",{className:"text-green-500 mr-2",children:"âœ“"}),(0,n.jsx)("span",{children:e})]},t))})]})]})]})})]})})};function h(){return(0,n.jsx)(u,{})}},5695:(e,t,r)=>{"use strict";var n=r(8999);r.o(n,"usePathname")&&r.d(t,{usePathname:function(){return n.usePathname}}),r.o(n,"useRouter")&&r.d(t,{useRouter:function(){return n.useRouter}}),r.o(n,"useSearchParams")&&r.d(t,{useSearchParams:function(){return n.useSearchParams}})},8497:(e,t,r)=>{Promise.resolve().then(r.bind(r,1760))}},e=>{var t=t=>e(e.s=t);e.O(0,[711,284,568,225,985,441,684,358],()=>t(8497)),_N_E=e.O()}]);